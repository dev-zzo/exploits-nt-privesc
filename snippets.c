/*
 * C code snippets for reuse in exploits
 */

/*
 * A version of puts() that doesn't require CRT
 */
static void __puts(const char *text)
{
    DWORD charsWritten;
    WriteConsoleA(GetStdHandle(STD_OUTPUT_HANDLE), text, strlen(text), &charsWritten, NULL);
}

/*
 * vsprintf() function from ntdll.
 */
typedef int (__cdecl *pvsprintf)(char *buffer, const char *format, va_list argptr); 
pvsprintf vsprintf; 

/*
 * A version of printf() that doesn't require CRT
 */
static int __printf(const char *fmt, ...)
{
    char buffer[1024];
    int length;
    DWORD charsWritten;
    va_list args;

    va_start(args, fmt);
    length = vsprintf(buffer, fmt, args);
    WriteConsoleA(GetStdHandle(STD_OUTPUT_HANDLE), buffer, length, &charsWritten, NULL);
    va_end(args);
    return length;
}

/*
 * Simply spawn a CMD shell.
 */
static int SpawnCmd(void)
{
	PROCESS_INFORMATION ProcInfo = {0,};
	STARTUPINFOA StartInfo = {0,};
    BOOL Success;

	StartInfo.cb = sizeof(StartInfo);
	Success = CreateProcessA(
		NULL,
		"C:\\windows\\system32\\cmd.exe",
		NULL,
		NULL,
		TRUE,
		CREATE_NEW_CONSOLE,
		NULL,
		NULL,
		&StartInfo,
		&ProcInfo);
    return Success;
}

/*
 * Allocate page zero
 */
static NTSTATUS MapPageZero(SIZE_T Size)
{
	PVOID BaseAddress = (PVOID)1;

	return NtAllocateVirtualMemory((PVOID)-1, &BaseAddress, 0, &Size, MEM_RESERVE|MEM_COMMIT|MEM_TOP_DOWN, PAGE_EXECUTE_READWRITE);
}

