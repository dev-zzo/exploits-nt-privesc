
#include <Windows.h>
#include <ntdll.h>

#pragma comment(linker, "/entry:__mainCRTStartup")
#pragma comment(linker, "/subsystem:console")
#pragma comment(lib, "kernel32")

/*
 * A version of puts() that doesn't require CRT
 */
static void __puts(const char *text)
{
    DWORD charsWritten;
    WriteConsoleA(GetStdHandle(STD_OUTPUT_HANDLE), text, strlen(text), &charsWritten, NULL);
}

/*
 * A version of printf() that doesn't require CRT
 */
static int __printf(const char *fmt, ...)
{
    char buffer[1024];
    int length;
    DWORD charsWritten;
    va_list args;

    va_start(args, fmt);
    length = vsprintf(buffer, fmt, args);
    WriteConsoleA(GetStdHandle(STD_OUTPUT_HANDLE), buffer, length, &charsWritten, NULL);
    va_end(args);
    return length;
}

typedef LONG (WINAPI *PRtlGetVersion)(PRTL_OSVERSIONINFOW);

static void DoIt(void)
{
    PRTL_PROCESS_MODULES ModuleTable;
    ULONG ModuleTableSize;
    ULONG Counter;
    PRTL_PROCESS_MODULE_INFORMATION Entry;
    NTSTATUS Status;

    ModuleTable = NULL;
    Status = STATUS_INFO_LENGTH_MISMATCH;
    for (ModuleTableSize = 65536; Status == STATUS_INFO_LENGTH_MISMATCH; ModuleTableSize += 16384) {
        HeapFree(GetProcessHeap(), 0, ModuleTable);
        ModuleTable = (PRTL_PROCESS_MODULES)HeapAlloc(GetProcessHeap(), 0, ModuleTableSize);
        Status = NtQuerySystemInformation(SystemModuleInformation, ModuleTable, ModuleTableSize, NULL);
    }

    Entry = &ModuleTable->Modules[0];
    __puts("\nBaseAddr     Size    Flags  Image name\n");
    for (Counter = ModuleTable->NumberOfModules; Counter > 0; --Counter) {
        if ((ULONG_PTR)Entry->ImageBase < 0x80000000) {
            break;
        }
        __printf("%08x %08x %08x  %s\n", Entry->ImageBase, Entry->ImageSize, Entry->Flags, Entry->FullPathName + Entry->OffsetToFileName);
        ++Entry;
    }
}

void __mainCRTStartup(void)
{
    __puts("\nNT kernel modules dumper\n");
    __puts("More at: https://github.com/dev-zzo/exploits-nt-privesc \n");

    DoIt();

	__puts("\n[+] XOXO, dev_zzo.\n");
}
