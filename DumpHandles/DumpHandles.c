
#include <Windows.h>
#include <ntdll.h>

#pragma comment(linker, "/entry:__mainCRTStartup")
#pragma comment(linker, "/subsystem:console")
#pragma comment(lib, "kernel32")

/*
 * A version of puts() that doesn't require CRT
 */
static void __puts(const char *text)
{
    DWORD charsWritten;
    WriteConsoleA(GetStdHandle(STD_OUTPUT_HANDLE), text, strlen(text), &charsWritten, NULL);
}

/*
 * A version of printf() that doesn't require CRT
 */
static int __printf(const char *fmt, ...)
{
    char buffer[1024];
    int length;
    DWORD charsWritten;
    va_list args;

    va_start(args, fmt);
    length = vsprintf(buffer, fmt, args);
    WriteConsoleA(GetStdHandle(STD_OUTPUT_HANDLE), buffer, length, &charsWritten, NULL);
    va_end(args);
    return length;
}

typedef LONG (WINAPI *PRtlGetVersion)(PRTL_OSVERSIONINFOW);

static void DoIt(void)
{
    PSYSTEM_HANDLE_INFORMATION Handles;
    ULONG HandleTableSize;
    ULONG FilledSize;
    ULONG Index;
    NTSTATUS Status;
    PRtlGetVersion RtlGetVersion;
    RTL_OSVERSIONINFOW ovi;
    ULONG OsVersion;

    RtlGetVersion = (PRtlGetVersion)GetProcAddress(GetModuleHandleA("ntdll.dll"), "RtlGetVersion");
    ovi.dwOSVersionInfoSize = sizeof(ovi);
    RtlGetVersion(&ovi);
    OsVersion = (ovi.dwMajorVersion << 8) | ovi.dwMinorVersion;

    Handles = NULL;
    Status = STATUS_INFO_LENGTH_MISMATCH;
    for (HandleTableSize = 65536; Status == STATUS_INFO_LENGTH_MISMATCH; HandleTableSize += 16384) {
        HeapFree(GetProcessHeap(), 0, Handles);
        Handles = (PSYSTEM_HANDLE_INFORMATION)HeapAlloc(GetProcessHeap(), 0, HandleTableSize);
        Status = NtQuerySystemInformation(SystemHandleInformation, Handles, HandleTableSize, &FilledSize);
    }

    __printf("%8s %8s %s\n", "Handle", "Address", "Object Type");
    for (Index = 0; Index < Handles->NumberOfHandles; ++Index) {
        PSYSTEM_HANDLE_TABLE_ENTRY_INFO Entry = &Handles->Handles[Index];
        const char *TypeName;

        if (Entry->UniqueProcessId != 4) {
            continue;
        }

        TypeName = NULL;

        /* This table needs to be updated with other Windows releases. */
        switch (OsVersion) {
        case 0x0601:
            /* Windows 7, Windows Server 2008 R2 */
            switch (Entry->ObjectTypeIndex) {
            case  3: TypeName = "Directory"; break;
            case  4: TypeName = "SymbolicLink"; break;
            case  5: TypeName = "Token"; break;
            case  7: TypeName = "Process"; break;
            case  8: TypeName = "Thread"; break;
            case 12: TypeName = "Event"; break;
            case 13: TypeName = "Mutant"; break;
            case 16: TypeName = "Timer"; break;
            case 21: TypeName = "Desktop"; break;
            case 27: TypeName = "IoCompletion"; break;
            case 28: TypeName = "File"; break;
            case 29: TypeName = "TmRm"; break;
            case 31: TypeName = "TmTm"; break;
            case 33: TypeName = "Section"; break;
            case 34: TypeName = "Session"; break;
            case 35: TypeName = "Key"; break;
            case 36: TypeName = "ALPC Port"; break;
            }
            break;

        case 0x0603:
            /* Windows 8.1, Windows Server 2012 R2 */
            switch (Entry->ObjectTypeIndex) {
            case  3: TypeName = "Directory"; break;
            case  4: TypeName = "SymbolicLink"; break;
            case  5: TypeName = "Token"; break;
            case  7: TypeName = "Process"; break;
            case  8: TypeName = "Thread"; break;
            case 12: TypeName = "Event"; break;
            case 13: TypeName = "Mutant"; break;
            case 16: TypeName = "Timer"; break;
            case 21: TypeName = "Desktop"; break;
            case 28: TypeName = "IoCompletion"; break;
            case 29: TypeName = "WaitCompletionPacket"; break;
            case 30: TypeName = "File"; break;
            case 31: TypeName = "TmTm"; break;
            case 33: TypeName = "TmRm"; break;
            case 35: TypeName = "Section"; break;
            case 36: TypeName = "Session"; break;
            case 37: TypeName = "Key"; break;
            case 38: TypeName = "ALPC Port"; break;
            case 43: TypeName = "FilterConnectionPort"; break;
            case 44: TypeName = "FilterCommunicationPort"; break;
            }
            break;
        }
        if (!TypeName) {
            TypeName = "UNKNOWN";
        }

        __printf("%8X %p %s (%d)\n", Entry->HandleValue, Entry->Object, TypeName, Entry->ObjectTypeIndex);
    }
}

void __mainCRTStartup(void)
{
    __puts("\nHandle dumper for SYSTEM\n");
    __puts("More at: https://github.com/dev-zzo/exploits-nt-privesc \n");

    __puts("\nThe below table lists all handles open in PID 4\n\n");
    DoIt();

	__puts("\n[+] XOXO, dev_zzo.\n");
}
