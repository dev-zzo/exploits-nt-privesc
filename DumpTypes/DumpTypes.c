
#include <Windows.h>
#include <ntdll.h>

#pragma comment(linker, "/entry:__mainCRTStartup")
#pragma comment(linker, "/subsystem:console")
#pragma comment(lib, "kernel32")

/*
 * A version of puts() that doesn't require CRT
 */
static void __puts(const char *text)
{
    DWORD charsWritten;
    WriteConsoleA(GetStdHandle(STD_OUTPUT_HANDLE), text, strlen(text), &charsWritten, NULL);
}

/*
 * A version of printf() that doesn't require CRT
 */
static int __printf(const char *fmt, ...)
{
    char buffer[1024];
    int length;
    DWORD charsWritten;
    va_list args;

    va_start(args, fmt);
    length = vsprintf(buffer, fmt, args);
    WriteConsoleA(GetStdHandle(STD_OUTPUT_HANDLE), buffer, length, &charsWritten, NULL);
    va_end(args);
    return length;
}

typedef LONG (WINAPI *PRtlGetVersion)(PRTL_OSVERSIONINFOW);

static void DoIt(void)
{
    POBJECT_TYPES_INFORMATION TypeTable;
    ULONG TypeTableSize;
    ULONG FilledSize;
    ULONG Counter;
    POBJECT_TYPE_INFORMATION Entry;
    NTSTATUS Status;
    WCHAR NameBuffer[128];

    TypeTable = NULL;
    Status = STATUS_INFO_LENGTH_MISMATCH;
    for (TypeTableSize = 65536; Status == STATUS_INFO_LENGTH_MISMATCH; TypeTableSize += 16384) {
        HeapFree(GetProcessHeap(), 0, TypeTable);
        TypeTable = (POBJECT_TYPES_INFORMATION)HeapAlloc(GetProcessHeap(), 0, TypeTableSize);
        Status = NtQueryObject(NULL, ObjectTypesInformation, TypeTable, TypeTableSize, &FilledSize);
    }

    Entry = &TypeTable->Types[0];
    for (Counter = TypeTable->NumberOfTypes; Counter > 0; --Counter) {
        USHORT NameBufferSize = (Entry->TypeName.MaximumLength + 3) & ~3;
        memset(NameBuffer, 0, sizeof(NameBuffer));
        memcpy(NameBuffer, Entry->TypeName.Buffer, Entry->TypeName.Length);
        __printf("\nType name: %S\n", NameBuffer);
        __printf("  Pool type: %x\n", Entry->PoolType);
        __printf("  Default charge quotas (paged/nonpaged): %04x/%04x\n", Entry->DefaultPagedPoolCharge, Entry->DefaultNonPagedPoolCharge);
        __printf("  Security required: %c\n", Entry->SecurityRequired ? 'Y' : 'N');
        __printf("  Maintain handle count: %c\n", Entry->MaintainHandleCount ? 'Y' : 'N');
        Entry = (POBJECT_TYPE_INFORMATION)((PBYTE)Entry + sizeof(*Entry) + NameBufferSize);
    }
}

void __mainCRTStartup(void)
{
    __puts("\nNT kernel type dumper\n");
    __puts("More at: https://github.com/dev-zzo/exploits-nt-privesc \n");

    __puts("\nThe below table lists all types known to the object manager.\n");
    DoIt();

	__puts("\n[+] XOXO, dev_zzo.\n");
}
